"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CostAnalysisTool = void 0;
const strands_agents_1 = require("strands-agents");
const client_cost_explorer_1 = require("@aws-sdk/client-cost-explorer");
/**
 * Tool for analyzing AWS costs using the Cost Explorer API
 */
class CostAnalysisTool extends strands_agents_1.Tool {
    constructor(region = 'us-east-1', retryConfig) {
        super();
        this.costExplorerClient = new client_cost_explorer_1.CostExplorerClient({ region });
        this.retryConfig = {
            maxAttempts: 3,
            baseDelay: 1000,
            maxDelay: 30000,
            backoffMultiplier: 2,
            ...retryConfig
        };
    }
    /**
     * Retrieves current month-to-date AWS costs
     */
    async getCurrentMonthCosts() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        // Format dates for Cost Explorer API (YYYY-MM-DD)
        const start = startOfMonth.toISOString().split('T')[0];
        const end = now.toISOString().split('T')[0];
        const input = {
            TimePeriod: {
                Start: start,
                End: end
            },
            Granularity: 'MONTHLY',
            Metrics: ['BlendedCost'],
            GroupBy: [
                {
                    Type: 'DIMENSION',
                    Key: 'SERVICE'
                }
            ]
        };
        try {
            const response = await this.executeWithRetry(() => this.costExplorerClient.send(new client_cost_explorer_1.GetCostAndUsageCommand(input)));
            return this.formatCostData(response, start, end, now, endOfMonth);
        }
        catch (error) {
            this.logger.error('Failed to retrieve cost data from Cost Explorer', { error });
            throw new Error(`Cost Explorer API error: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    /**
     * Formats raw Cost Explorer API response into CostAnalysis object
     */
    formatCostData(response, start, end, now, endOfMonth) {
        const serviceBreakdown = {};
        let totalCost = 0;
        if (response.ResultsByTime && response.ResultsByTime.length > 0) {
            const result = response.ResultsByTime[0];
            if (result.Groups) {
                for (const group of result.Groups) {
                    const serviceName = group.Keys?.[0] || 'Unknown Service';
                    const cost = parseFloat(group.Metrics?.BlendedCost?.Amount || '0');
                    if (cost > 0) {
                        serviceBreakdown[serviceName] = cost;
                        totalCost += cost;
                    }
                }
            }
            // Also include total from the result if available
            if (result.Total?.BlendedCost?.Amount) {
                const apiTotal = parseFloat(result.Total.BlendedCost.Amount);
                if (apiTotal > totalCost) {
                    totalCost = apiTotal;
                }
            }
        }
        // Calculate projected monthly cost
        const projectedMonthly = this.calculateProjectedMonthlyCost(totalCost, now, endOfMonth);
        return {
            totalCost,
            serviceBreakdown,
            period: {
                start: `${start}T00:00:00.000Z`,
                end: `${end}T23:59:59.999Z`
            },
            projectedMonthly,
            currency: 'USD',
            lastUpdated: new Date().toISOString()
        };
    }
    /**
     * Calculates projected monthly cost based on current usage
     */
    calculateProjectedMonthlyCost(currentCost, now, endOfMonth) {
        const dayOfMonth = now.getDate();
        const daysInMonth = endOfMonth.getDate();
        if (dayOfMonth === 0) {
            return currentCost;
        }
        // Simple linear projection based on elapsed days
        const projectedCost = (currentCost / dayOfMonth) * daysInMonth;
        // Round to 2 decimal places
        return Math.round(projectedCost * 100) / 100;
    }
    /**
     * Gets top cost-driving services sorted by cost
     */
    getTopServices(costAnalysis, limit = 5, minThreshold = 1) {
        const services = Object.entries(costAnalysis.serviceBreakdown)
            .filter(([_, cost]) => cost >= minThreshold)
            .map(([serviceName, cost]) => ({
            serviceName,
            cost,
            percentage: Math.round((cost / costAnalysis.totalCost) * 100 * 100) / 100 // Round to 2 decimal places
        }))
            .sort((a, b) => b.cost - a.cost)
            .slice(0, limit);
        return services;
    }
    /**
     * Groups small services under "Other services" category
     */
    consolidateSmallServices(costAnalysis, minThreshold = 1) {
        const consolidatedBreakdown = {};
        let otherServicesCost = 0;
        for (const [serviceName, cost] of Object.entries(costAnalysis.serviceBreakdown)) {
            if (cost >= minThreshold) {
                consolidatedBreakdown[serviceName] = cost;
            }
            else {
                otherServicesCost += cost;
            }
        }
        if (otherServicesCost > 0) {
            consolidatedBreakdown['Other services'] = otherServicesCost;
        }
        return {
            ...costAnalysis,
            serviceBreakdown: consolidatedBreakdown
        };
    }
    /**
     * Executes a function with exponential backoff retry logic
     */
    async executeWithRetry(fn) {
        let lastError;
        for (let attempt = 1; attempt <= this.retryConfig.maxAttempts; attempt++) {
            try {
                return await fn();
            }
            catch (error) {
                lastError = error instanceof Error ? error : new Error('Unknown error');
                if (attempt === this.retryConfig.maxAttempts) {
                    break;
                }
                // Check if error is retryable
                if (!this.isRetryableError(error)) {
                    throw lastError;
                }
                const delay = Math.min(this.retryConfig.baseDelay * Math.pow(this.retryConfig.backoffMultiplier, attempt - 1), this.retryConfig.maxDelay);
                this.logger.warn(`Cost Explorer API call failed, retrying in ${delay}ms`, {
                    attempt,
                    maxAttempts: this.retryConfig.maxAttempts,
                    error: lastError.message
                });
                await this.sleep(delay);
            }
        }
        throw lastError;
    }
    /**
     * Determines if an error is retryable
     */
    isRetryableError(error) {
        if (!error)
            return false;
        // AWS SDK error codes that are retryable
        const retryableErrorCodes = [
            'ThrottlingException',
            'Throttling',
            'TooManyRequestsException',
            'ServiceUnavailable',
            'InternalServerError',
            'RequestTimeout'
        ];
        // Check error code
        if (error.name && retryableErrorCodes.includes(error.name)) {
            return true;
        }
        // Check HTTP status codes
        if (error.$metadata?.httpStatusCode) {
            const statusCode = error.$metadata.httpStatusCode;
            return statusCode >= 500 || statusCode === 429;
        }
        // Check for network errors
        if (error.code === 'ECONNRESET' || error.code === 'ETIMEDOUT') {
            return true;
        }
        return false;
    }
    /**
     * Sleep utility for retry delays
     */
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    /**
     * Validates date range for cost analysis
     */
    validateDateRange(start, end) {
        if (start >= end) {
            throw new Error('Start date must be before end date');
        }
        const now = new Date();
        if (end > now) {
            throw new Error('End date cannot be in the future');
        }
        const maxRangeMonths = 12;
        const maxEndDate = new Date(start);
        maxEndDate.setMonth(maxEndDate.getMonth() + maxRangeMonths);
        if (end > maxEndDate) {
            throw new Error(`Date range cannot exceed ${maxRangeMonths} months`);
        }
    }
    /**
     * Gets cost data for a custom date range
     */
    async getCostDataForRange(startDate, endDate) {
        this.validateDateRange(startDate, endDate);
        const start = startDate.toISOString().split('T')[0];
        const end = endDate.toISOString().split('T')[0];
        const input = {
            TimePeriod: {
                Start: start,
                End: end
            },
            Granularity: 'MONTHLY',
            Metrics: ['BlendedCost'],
            GroupBy: [
                {
                    Type: 'DIMENSION',
                    Key: 'SERVICE'
                }
            ]
        };
        try {
            const response = await this.executeWithRetry(() => this.costExplorerClient.send(new client_cost_explorer_1.GetCostAndUsageCommand(input)));
            return this.formatCostData(response, start, end, endDate, endDate);
        }
        catch (error) {
            this.logger.error('Failed to retrieve cost data for custom range', {
                error,
                startDate: start,
                endDate: end
            });
            throw new Error(`Cost Explorer API error: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
}
exports.CostAnalysisTool = CostAnalysisTool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29zdC1hbmFseXNpcy10b29sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3Rvb2xzL2Nvc3QtYW5hbHlzaXMtdG9vbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtREFBc0M7QUFDdEMsd0VBQXdIO0FBR3hIOztHQUVHO0FBQ0gsTUFBYSxnQkFBaUIsU0FBUSxxQkFBSTtJQUl4QyxZQUFZLFNBQWlCLFdBQVcsRUFBRSxXQUFrQztRQUMxRSxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLHlDQUFrQixDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHO1lBQ2pCLFdBQVcsRUFBRSxDQUFDO1lBQ2QsU0FBUyxFQUFFLElBQUk7WUFDZixRQUFRLEVBQUUsS0FBSztZQUNmLGlCQUFpQixFQUFFLENBQUM7WUFDcEIsR0FBRyxXQUFXO1NBQ2YsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxvQkFBb0I7UUFDeEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN2QixNQUFNLFlBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sVUFBVSxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXRFLGtEQUFrRDtRQUNsRCxNQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FB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QUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLDZDQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQ2hFLENBQUM7WUFFRixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3JFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsK0NBQStDLEVBQUU7Z0JBQ2pFLEtBQUs7Z0JBQ0wsU0FBUyxFQUFFLEtBQUs7Z0JBQ2hCLE9BQU8sRUFBRSxHQUFHO2FBQ2IsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxJQUFJLEtBQUssQ0FBQyw0QkFBNEIsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQztRQUMxRyxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBaFRELDRDQWdUQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRvb2wgfSBmcm9tICdzdHJhbmRzLWFnZW50cyc7XG5pbXBvcnQgeyBDb3N0RXhwbG9yZXJDbGllbnQsIEdldENvc3RBbmRVc2FnZUNvbW1hbmQsIEdldENvc3RBbmRVc2FnZUNvbW1hbmRJbnB1dCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jb3N0LWV4cGxvcmVyJztcbmltcG9ydCB7IENvc3RBbmFseXNpcywgU2VydmljZUNvc3QsIFJldHJ5Q29uZmlnIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG4vKipcbiAqIFRvb2wgZm9yIGFuYWx5emluZyBBV1MgY29zdHMgdXNpbmcgdGhlIENvc3QgRXhwbG9yZXIgQVBJXG4gKi9cbmV4cG9ydCBjbGFzcyBDb3N0QW5hbHlzaXNUb29sIGV4dGVuZHMgVG9vbCB7XG4gIHByaXZhdGUgY29zdEV4cGxvcmVyQ2xpZW50OiBDb3N0RXhwbG9yZXJDbGllbnQ7XG4gIHByaXZhdGUgcmV0cnlDb25maWc6IFJldHJ5Q29uZmlnO1xuXG4gIGNvbnN0cnVjdG9yKHJlZ2lvbjogc3RyaW5nID0gJ3VzLWVhc3QtMScsIHJldHJ5Q29uZmlnPzogUGFydGlhbDxSZXRyeUNvbmZpZz4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY29zdEV4cGxvcmVyQ2xpZW50ID0gbmV3IENvc3RFeHBsb3JlckNsaWVudCh7IHJlZ2lvbiB9KTtcbiAgICB0aGlzLnJldHJ5Q29uZmlnID0ge1xuICAgICAgbWF4QXR0ZW1wdHM6IDMsXG4gICAgICBiYXNlRGVsYXk6IDEwMDAsXG4gICAgICBtYXhEZWxheTogMzAwMDAsXG4gICAgICBiYWNrb2ZmTXVsdGlwbGllcjogMixcbiAgICAgIC4uLnJldHJ5Q29uZmlnXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgY3VycmVudCBtb250aC10by1kYXRlIEFXUyBjb3N0c1xuICAgKi9cbiAgYXN5bmMgZ2V0Q3VycmVudE1vbnRoQ29zdHMoKTogUHJvbWlzZTxDb3N0QW5hbHlzaXM+IHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHN0YXJ0T2ZNb250aCA9IG5ldyBEYXRlKG5vdy5nZXRGdWxsWWVhcigpLCBub3cuZ2V0TW9udGgoKSwgMSk7XG4gICAgY29uc3QgZW5kT2ZNb250aCA9IG5ldyBEYXRlKG5vdy5nZXRGdWxsWWVhcigpLCBub3cuZ2V0TW9udGgoKSArIDEsIDApO1xuICAgIFxuICAgIC8vIEZvcm1hdCBkYXRlcyBmb3IgQ29zdCBFeHBsb3JlciBBUEkgKFlZWVktTU0tREQpXG4gICAgY29uc3Qgc3RhcnQgPSBzdGFydE9mTW9udGgudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdO1xuICAgIGNvbnN0IGVuZCA9IG5vdy50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF07XG5cbiAgICBjb25zdCBpbnB1dDogR2V0Q29zdEFuZFVzYWdlQ29tbWFuZElucHV0ID0ge1xuICAgICAgVGltZVBlcmlvZDoge1xuICAgICAgICBTdGFydDogc3RhcnQsXG4gICAgICAgIEVuZDogZW5kXG4gICAgICB9LFxuICAgICAgR3JhbnVsYXJpdHk6ICdNT05USExZJyxcbiAgICAgIE1ldHJpY3M6IFsnQmxlbmRlZENvc3QnXSxcbiAgICAgIEdyb3VwQnk6IFtcbiAgICAgICAge1xuICAgICAgICAgIFR5cGU6ICdESU1FTlNJT04nLFxuICAgICAgICAgIEtleTogJ1NFUlZJQ0UnXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5leGVjdXRlV2l0aFJldHJ5KCgpID0+IFxuICAgICAgICB0aGlzLmNvc3RFeHBsb3JlckNsaWVudC5zZW5kKG5ldyBHZXRDb3N0QW5kVXNhZ2VDb21tYW5kKGlucHV0KSlcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdENvc3REYXRhKHJlc3BvbnNlLCBzdGFydCwgZW5kLCBub3csIGVuZE9mTW9udGgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIGNvc3QgZGF0YSBmcm9tIENvc3QgRXhwbG9yZXInLCB7IGVycm9yIH0pO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3N0IEV4cGxvcmVyIEFQSSBlcnJvcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0cyByYXcgQ29zdCBFeHBsb3JlciBBUEkgcmVzcG9uc2UgaW50byBDb3N0QW5hbHlzaXMgb2JqZWN0XG4gICAqL1xuICBwcml2YXRlIGZvcm1hdENvc3REYXRhKHJlc3BvbnNlOiBhbnksIHN0YXJ0OiBzdHJpbmcsIGVuZDogc3RyaW5nLCBub3c6IERhdGUsIGVuZE9mTW9udGg6IERhdGUpOiBDb3N0QW5hbHlzaXMge1xuICAgIGNvbnN0IHNlcnZpY2VCcmVha2Rvd246IHsgW3NlcnZpY2U6IHN0cmluZ106IG51bWJlciB9ID0ge307XG4gICAgbGV0IHRvdGFsQ29zdCA9IDA7XG5cbiAgICBpZiAocmVzcG9uc2UuUmVzdWx0c0J5VGltZSAmJiByZXNwb25zZS5SZXN1bHRzQnlUaW1lLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlLlJlc3VsdHNCeVRpbWVbMF07XG4gICAgICBcbiAgICAgIGlmIChyZXN1bHQuR3JvdXBzKSB7XG4gICAgICAgIGZvciAoY29uc3QgZ3JvdXAgb2YgcmVzdWx0Lkdyb3Vwcykge1xuICAgICAgICAgIGNvbnN0IHNlcnZpY2VOYW1lID0gZ3JvdXAuS2V5cz8uWzBdIHx8ICdVbmtub3duIFNlcnZpY2UnO1xuICAgICAgICAgIGNvbnN0IGNvc3QgPSBwYXJzZUZsb2F0KGdyb3VwLk1ldHJpY3M/LkJsZW5kZWRDb3N0Py5BbW91bnQgfHwgJzAnKTtcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAoY29zdCA+IDApIHtcbiAgICAgICAgICAgIHNlcnZpY2VCcmVha2Rvd25bc2VydmljZU5hbWVdID0gY29zdDtcbiAgICAgICAgICAgIHRvdGFsQ29zdCArPSBjb3N0O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBBbHNvIGluY2x1ZGUgdG90YWwgZnJvbSB0aGUgcmVzdWx0IGlmIGF2YWlsYWJsZVxuICAgICAgaWYgKHJlc3VsdC5Ub3RhbD8uQmxlbmRlZENvc3Q/LkFtb3VudCkge1xuICAgICAgICBjb25zdCBhcGlUb3RhbCA9IHBhcnNlRmxvYXQocmVzdWx0LlRvdGFsLkJsZW5kZWRDb3N0LkFtb3VudCk7XG4gICAgICAgIGlmIChhcGlUb3RhbCA+IHRvdGFsQ29zdCkge1xuICAgICAgICAgIHRvdGFsQ29zdCA9IGFwaVRvdGFsO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHByb2plY3RlZCBtb250aGx5IGNvc3RcbiAgICBjb25zdCBwcm9qZWN0ZWRNb250aGx5ID0gdGhpcy5jYWxjdWxhdGVQcm9qZWN0ZWRNb250aGx5Q29zdCh0b3RhbENvc3QsIG5vdywgZW5kT2ZNb250aCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxDb3N0LFxuICAgICAgc2VydmljZUJyZWFrZG93bixcbiAgICAgIHBlcmlvZDoge1xuICAgICAgICBzdGFydDogYCR7c3RhcnR9VDAwOjAwOjAwLjAwMFpgLFxuICAgICAgICBlbmQ6IGAke2VuZH1UMjM6NTk6NTkuOTk5WmBcbiAgICAgIH0sXG4gICAgICBwcm9qZWN0ZWRNb250aGx5LFxuICAgICAgY3VycmVuY3k6ICdVU0QnLFxuICAgICAgbGFzdFVwZGF0ZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlcyBwcm9qZWN0ZWQgbW9udGhseSBjb3N0IGJhc2VkIG9uIGN1cnJlbnQgdXNhZ2VcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlUHJvamVjdGVkTW9udGhseUNvc3QoY3VycmVudENvc3Q6IG51bWJlciwgbm93OiBEYXRlLCBlbmRPZk1vbnRoOiBEYXRlKTogbnVtYmVyIHtcbiAgICBjb25zdCBkYXlPZk1vbnRoID0gbm93LmdldERhdGUoKTtcbiAgICBjb25zdCBkYXlzSW5Nb250aCA9IGVuZE9mTW9udGguZ2V0RGF0ZSgpO1xuICAgIFxuICAgIGlmIChkYXlPZk1vbnRoID09PSAwKSB7XG4gICAgICByZXR1cm4gY3VycmVudENvc3Q7XG4gICAgfVxuXG4gICAgLy8gU2ltcGxlIGxpbmVhciBwcm9qZWN0aW9uIGJhc2VkIG9uIGVsYXBzZWQgZGF5c1xuICAgIGNvbnN0IHByb2plY3RlZENvc3QgPSAoY3VycmVudENvc3QgLyBkYXlPZk1vbnRoKSAqIGRheXNJbk1vbnRoO1xuICAgIFxuICAgIC8vIFJvdW5kIHRvIDIgZGVjaW1hbCBwbGFjZXNcbiAgICByZXR1cm4gTWF0aC5yb3VuZChwcm9qZWN0ZWRDb3N0ICogMTAwKSAvIDEwMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRvcCBjb3N0LWRyaXZpbmcgc2VydmljZXMgc29ydGVkIGJ5IGNvc3RcbiAgICovXG4gIGdldFRvcFNlcnZpY2VzKGNvc3RBbmFseXNpczogQ29zdEFuYWx5c2lzLCBsaW1pdDogbnVtYmVyID0gNSwgbWluVGhyZXNob2xkOiBudW1iZXIgPSAxKTogU2VydmljZUNvc3RbXSB7XG4gICAgY29uc3Qgc2VydmljZXMgPSBPYmplY3QuZW50cmllcyhjb3N0QW5hbHlzaXMuc2VydmljZUJyZWFrZG93bilcbiAgICAgIC5maWx0ZXIoKFtfLCBjb3N0XSkgPT4gY29zdCA+PSBtaW5UaHJlc2hvbGQpXG4gICAgICAubWFwKChbc2VydmljZU5hbWUsIGNvc3RdKSA9PiAoe1xuICAgICAgICBzZXJ2aWNlTmFtZSxcbiAgICAgICAgY29zdCxcbiAgICAgICAgcGVyY2VudGFnZTogTWF0aC5yb3VuZCgoY29zdCAvIGNvc3RBbmFseXNpcy50b3RhbENvc3QpICogMTAwICogMTAwKSAvIDEwMCAvLyBSb3VuZCB0byAyIGRlY2ltYWwgcGxhY2VzXG4gICAgICB9KSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiLmNvc3QgLSBhLmNvc3QpXG4gICAgICAuc2xpY2UoMCwgbGltaXQpO1xuXG4gICAgcmV0dXJuIHNlcnZpY2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdyb3VwcyBzbWFsbCBzZXJ2aWNlcyB1bmRlciBcIk90aGVyIHNlcnZpY2VzXCIgY2F0ZWdvcnlcbiAgICovXG4gIGNvbnNvbGlkYXRlU21hbGxTZXJ2aWNlcyhjb3N0QW5hbHlzaXM6IENvc3RBbmFseXNpcywgbWluVGhyZXNob2xkOiBudW1iZXIgPSAxKTogQ29zdEFuYWx5c2lzIHtcbiAgICBjb25zdCBjb25zb2xpZGF0ZWRCcmVha2Rvd246IHsgW3NlcnZpY2U6IHN0cmluZ106IG51bWJlciB9ID0ge307XG4gICAgbGV0IG90aGVyU2VydmljZXNDb3N0ID0gMDtcblxuICAgIGZvciAoY29uc3QgW3NlcnZpY2VOYW1lLCBjb3N0XSBvZiBPYmplY3QuZW50cmllcyhjb3N0QW5hbHlzaXMuc2VydmljZUJyZWFrZG93bikpIHtcbiAgICAgIGlmIChjb3N0ID49IG1pblRocmVzaG9sZCkge1xuICAgICAgICBjb25zb2xpZGF0ZWRCcmVha2Rvd25bc2VydmljZU5hbWVdID0gY29zdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG90aGVyU2VydmljZXNDb3N0ICs9IGNvc3Q7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKG90aGVyU2VydmljZXNDb3N0ID4gMCkge1xuICAgICAgY29uc29saWRhdGVkQnJlYWtkb3duWydPdGhlciBzZXJ2aWNlcyddID0gb3RoZXJTZXJ2aWNlc0Nvc3Q7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmNvc3RBbmFseXNpcyxcbiAgICAgIHNlcnZpY2VCcmVha2Rvd246IGNvbnNvbGlkYXRlZEJyZWFrZG93blxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZXMgYSBmdW5jdGlvbiB3aXRoIGV4cG9uZW50aWFsIGJhY2tvZmYgcmV0cnkgbG9naWNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZXhlY3V0ZVdpdGhSZXRyeTxUPihmbjogKCkgPT4gUHJvbWlzZTxUPik6IFByb21pc2U8VD4ge1xuICAgIGxldCBsYXN0RXJyb3I6IEVycm9yO1xuICAgIFxuICAgIGZvciAobGV0IGF0dGVtcHQgPSAxOyBhdHRlbXB0IDw9IHRoaXMucmV0cnlDb25maWcubWF4QXR0ZW1wdHM7IGF0dGVtcHQrKykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZuKCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsYXN0RXJyb3IgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IoJ1Vua25vd24gZXJyb3InKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChhdHRlbXB0ID09PSB0aGlzLnJldHJ5Q29uZmlnLm1heEF0dGVtcHRzKSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBpZiBlcnJvciBpcyByZXRyeWFibGVcbiAgICAgICAgaWYgKCF0aGlzLmlzUmV0cnlhYmxlRXJyb3IoZXJyb3IpKSB7XG4gICAgICAgICAgdGhyb3cgbGFzdEVycm9yO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGVsYXkgPSBNYXRoLm1pbihcbiAgICAgICAgICB0aGlzLnJldHJ5Q29uZmlnLmJhc2VEZWxheSAqIE1hdGgucG93KHRoaXMucmV0cnlDb25maWcuYmFja29mZk11bHRpcGxpZXIsIGF0dGVtcHQgLSAxKSxcbiAgICAgICAgICB0aGlzLnJldHJ5Q29uZmlnLm1heERlbGF5XG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgQ29zdCBFeHBsb3JlciBBUEkgY2FsbCBmYWlsZWQsIHJldHJ5aW5nIGluICR7ZGVsYXl9bXNgLCB7XG4gICAgICAgICAgYXR0ZW1wdCxcbiAgICAgICAgICBtYXhBdHRlbXB0czogdGhpcy5yZXRyeUNvbmZpZy5tYXhBdHRlbXB0cyxcbiAgICAgICAgICBlcnJvcjogbGFzdEVycm9yLm1lc3NhZ2VcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5zbGVlcChkZWxheSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgbGFzdEVycm9yITtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIGlmIGFuIGVycm9yIGlzIHJldHJ5YWJsZVxuICAgKi9cbiAgcHJpdmF0ZSBpc1JldHJ5YWJsZUVycm9yKGVycm9yOiBhbnkpOiBib29sZWFuIHtcbiAgICBpZiAoIWVycm9yKSByZXR1cm4gZmFsc2U7XG5cbiAgICAvLyBBV1MgU0RLIGVycm9yIGNvZGVzIHRoYXQgYXJlIHJldHJ5YWJsZVxuICAgIGNvbnN0IHJldHJ5YWJsZUVycm9yQ29kZXMgPSBbXG4gICAgICAnVGhyb3R0bGluZ0V4Y2VwdGlvbicsXG4gICAgICAnVGhyb3R0bGluZycsXG4gICAgICAnVG9vTWFueVJlcXVlc3RzRXhjZXB0aW9uJyxcbiAgICAgICdTZXJ2aWNlVW5hdmFpbGFibGUnLFxuICAgICAgJ0ludGVybmFsU2VydmVyRXJyb3InLFxuICAgICAgJ1JlcXVlc3RUaW1lb3V0J1xuICAgIF07XG5cbiAgICAvLyBDaGVjayBlcnJvciBjb2RlXG4gICAgaWYgKGVycm9yLm5hbWUgJiYgcmV0cnlhYmxlRXJyb3JDb2Rlcy5pbmNsdWRlcyhlcnJvci5uYW1lKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgSFRUUCBzdGF0dXMgY29kZXNcbiAgICBpZiAoZXJyb3IuJG1ldGFkYXRhPy5odHRwU3RhdHVzQ29kZSkge1xuICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IGVycm9yLiRtZXRhZGF0YS5odHRwU3RhdHVzQ29kZTtcbiAgICAgIHJldHVybiBzdGF0dXNDb2RlID49IDUwMCB8fCBzdGF0dXNDb2RlID09PSA0Mjk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIG5ldHdvcmsgZXJyb3JzXG4gICAgaWYgKGVycm9yLmNvZGUgPT09ICdFQ09OTlJFU0VUJyB8fCBlcnJvci5jb2RlID09PSAnRVRJTUVET1VUJykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNsZWVwIHV0aWxpdHkgZm9yIHJldHJ5IGRlbGF5c1xuICAgKi9cbiAgcHJpdmF0ZSBzbGVlcChtczogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyBkYXRlIHJhbmdlIGZvciBjb3N0IGFuYWx5c2lzXG4gICAqL1xuICB2YWxpZGF0ZURhdGVSYW5nZShzdGFydDogRGF0ZSwgZW5kOiBEYXRlKTogdm9pZCB7XG4gICAgaWYgKHN0YXJ0ID49IGVuZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTdGFydCBkYXRlIG11c3QgYmUgYmVmb3JlIGVuZCBkYXRlJyk7XG4gICAgfVxuXG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBpZiAoZW5kID4gbm93KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuZCBkYXRlIGNhbm5vdCBiZSBpbiB0aGUgZnV0dXJlJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbWF4UmFuZ2VNb250aHMgPSAxMjtcbiAgICBjb25zdCBtYXhFbmREYXRlID0gbmV3IERhdGUoc3RhcnQpO1xuICAgIG1heEVuZERhdGUuc2V0TW9udGgobWF4RW5kRGF0ZS5nZXRNb250aCgpICsgbWF4UmFuZ2VNb250aHMpO1xuICAgIFxuICAgIGlmIChlbmQgPiBtYXhFbmREYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGUgcmFuZ2UgY2Fubm90IGV4Y2VlZCAke21heFJhbmdlTW9udGhzfSBtb250aHNgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBjb3N0IGRhdGEgZm9yIGEgY3VzdG9tIGRhdGUgcmFuZ2VcbiAgICovXG4gIGFzeW5jIGdldENvc3REYXRhRm9yUmFuZ2Uoc3RhcnREYXRlOiBEYXRlLCBlbmREYXRlOiBEYXRlKTogUHJvbWlzZTxDb3N0QW5hbHlzaXM+IHtcbiAgICB0aGlzLnZhbGlkYXRlRGF0ZVJhbmdlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XG5cbiAgICBjb25zdCBzdGFydCA9IHN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF07XG4gICAgY29uc3QgZW5kID0gZW5kRGF0ZS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF07XG5cbiAgICBjb25zdCBpbnB1dDogR2V0Q29zdEFuZFVzYWdlQ29tbWFuZElucHV0ID0ge1xuICAgICAgVGltZVBlcmlvZDoge1xuICAgICAgICBTdGFydDogc3RhcnQsXG4gICAgICAgIEVuZDogZW5kXG4gICAgICB9LFxuICAgICAgR3JhbnVsYXJpdHk6ICdNT05USExZJyxcbiAgICAgIE1ldHJpY3M6IFsnQmxlbmRlZENvc3QnXSxcbiAgICAgIEdyb3VwQnk6IFtcbiAgICAgICAge1xuICAgICAgICAgIFR5cGU6ICdESU1FTlNJT04nLFxuICAgICAgICAgIEtleTogJ1NFUlZJQ0UnXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5leGVjdXRlV2l0aFJldHJ5KCgpID0+IFxuICAgICAgICB0aGlzLmNvc3RFeHBsb3JlckNsaWVudC5zZW5kKG5ldyBHZXRDb3N0QW5kVXNhZ2VDb21tYW5kKGlucHV0KSlcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdENvc3REYXRhKHJlc3BvbnNlLCBzdGFydCwgZW5kLCBlbmREYXRlLCBlbmREYXRlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBjb3N0IGRhdGEgZm9yIGN1c3RvbSByYW5nZScsIHsgXG4gICAgICAgIGVycm9yLCBcbiAgICAgICAgc3RhcnREYXRlOiBzdGFydCwgXG4gICAgICAgIGVuZERhdGU6IGVuZCBcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3N0IEV4cGxvcmVyIEFQSSBlcnJvcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gKTtcbiAgICB9XG4gIH1cbn0iXX0=