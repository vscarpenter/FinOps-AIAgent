{
 "Description": "AWS Strands agent for monitoring spend and generating alerts",
 "Resources": {
  "SpendMonitorLogGroup367930B7": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "/aws/lambda/spend-monitor-agent",
    "RetentionInDays": 30
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendMonitorLogGroup/Resource"
   }
  },
  "SpendAlertTopic7E2315E1": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "AWS Spend Monitor Alerts",
    "TopicName": "aws-spend-alerts"
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendAlertTopic/Resource"
   }
  },
  "DeviceTokenTable5D54629B": {
   "Type": "AWS::DynamoDB::Table",
   "Properties": {
    "AttributeDefinitions": [
     {
      "AttributeName": "deviceToken",
      "AttributeType": "S"
     }
    ],
    "BillingMode": "PAY_PER_REQUEST",
    "KeySchema": [
     {
      "AttributeName": "deviceToken",
      "KeyType": "HASH"
     }
    ],
    "PointInTimeRecoverySpecification": {
     "PointInTimeRecoveryEnabled": true
    },
    "TableName": "spend-monitor-device-tokens"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/DeviceTokenTable/Resource"
   }
  },
  "SpendMonitorAgentServiceRoleD4CAE3C2": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendMonitorAgent/ServiceRole/Resource"
   }
  },
  "SpendMonitorAgentServiceRoleDefaultPolicyC1138BB7": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ce:GetCostAndUsage",
        "ce:GetDimensionValues",
        "ce:GetReservationCoverage",
        "ce:GetReservationPurchaseRecommendation",
        "ce:GetReservationUtilization",
        "ce:GetUsageReport",
        "cloudwatch:PutMetricData"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": "sns:Publish",
       "Effect": "Allow",
       "Resource": {
        "Ref": "SpendAlertTopic7E2315E1"
       }
      },
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:ConditionCheckItem",
        "dynamodb:DeleteItem",
        "dynamodb:DescribeTable",
        "dynamodb:GetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:PutItem",
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:UpdateItem"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "DeviceTokenTable5D54629B",
          "Arn"
         ]
        },
        {
         "Ref": "AWS::NoValue"
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "SpendMonitorAgentServiceRoleDefaultPolicyC1138BB7",
    "Roles": [
     {
      "Ref": "SpendMonitorAgentServiceRoleD4CAE3C2"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendMonitorAgent/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "SpendMonitorAgentBEC3B4B9": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-710603110067-us-east-1",
     "S3Key": "20c6e518897152edcc4eafbbd322906f52e24272f4df9ce078a1d4b690d5dd86.zip"
    },
    "Environment": {
     "Variables": {
      "SNS_TOPIC_ARN": {
       "Ref": "SpendAlertTopic7E2315E1"
      },
      "SPEND_THRESHOLD": "10",
      "CHECK_PERIOD_DAYS": "1",
      "RETRY_ATTEMPTS": "3",
      "MIN_SERVICE_COST": "1",
      "IOS_PLATFORM_APP_ARN": "",
      "IOS_BUNDLE_ID": "com.vinny.aws.spendmonitor",
      "APNS_SANDBOX": "true",
      "DEVICE_TOKEN_TABLE_NAME": {
       "Ref": "DeviceTokenTable5D54629B"
      }
     }
    },
    "Handler": "index.handler",
    "LoggingConfig": {
     "LogGroup": {
      "Ref": "SpendMonitorLogGroup367930B7"
     }
    },
    "MemorySize": 512,
    "Role": {
     "Fn::GetAtt": [
      "SpendMonitorAgentServiceRoleD4CAE3C2",
      "Arn"
     ]
    },
    "Runtime": "nodejs18.x",
    "Timeout": 300
   },
   "DependsOn": [
    "SpendMonitorAgentServiceRoleDefaultPolicyC1138BB7",
    "SpendMonitorAgentServiceRoleD4CAE3C2"
   ],
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendMonitorAgent/Resource",
    "aws:asset:path": "asset.20c6e518897152edcc4eafbbd322906f52e24272f4df9ce078a1d4b690d5dd86",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "SpendCheckSchedule7DC10937": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "Description": "Daily AWS spend check at 9:00 UTC",
    "ScheduleExpression": "cron(0 9 * * ? *)",
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "SpendMonitorAgentBEC3B4B9",
        "Arn"
       ]
      },
      "Id": "Target0"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendCheckSchedule/Resource"
   }
  },
  "SpendCheckScheduleAllowEventRuleSpendMonitorStackSpendMonitorAgent55373C3450249616": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "SpendMonitorAgentBEC3B4B9",
      "Arn"
     ]
    },
    "Principal": "events.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "SpendCheckSchedule7DC10937",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendCheckSchedule/AllowEventRuleSpendMonitorStackSpendMonitorAgent55373C34"
   }
  },
  "OperationalAlertTopicB3F33E16": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "Spend Monitor Operational Alerts",
    "TopicName": "spend-monitor-ops-alerts"
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/OperationalAlertTopic/Resource"
   }
  },
  "LambdaErrorAlarm646BFA4C": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "OperationalAlertTopicB3F33E16"
     }
    ],
    "AlarmDescription": "Alarm for Lambda function errors in spend monitor",
    "AlarmName": "SpendMonitor-LambdaErrors",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": {
       "Ref": "SpendMonitorAgentBEC3B4B9"
      }
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Errors",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 1,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/LambdaErrorAlarm/Resource"
   }
  },
  "LambdaDurationAlarmA8007F1F": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "OperationalAlertTopicB3F33E16"
     }
    ],
    "AlarmDescription": "Alarm for Lambda function execution duration",
    "AlarmName": "SpendMonitor-LambdaDuration",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": {
       "Ref": "SpendMonitorAgentBEC3B4B9"
      }
     }
    ],
    "EvaluationPeriods": 2,
    "MetricName": "Duration",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Average",
    "Threshold": 240000,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/LambdaDurationAlarm/Resource"
   }
  },
  "ExecutionFailureAlarm65D8EF83": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "OperationalAlertTopicB3F33E16"
     }
    ],
    "AlarmDescription": "Alarm for spend monitor execution failures",
    "AlarmName": "SpendMonitor-ExecutionFailures",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "Operation",
      "Value": "SpendMonitoring"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "ErrorRate",
    "Namespace": "SpendMonitor/Agent",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 1,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/ExecutionFailureAlarm/Resource"
   }
  },
  "AlertDeliveryFailureAlarm03B2D208": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "OperationalAlertTopicB3F33E16"
     }
    ],
    "AlarmDescription": "Alarm for alert delivery failures",
    "AlarmName": "SpendMonitor-AlertDeliveryFailures",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "Status",
      "Value": "Failure"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "AlertDeliveryCount",
    "Namespace": "SpendMonitor/Agent",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 1,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/AlertDeliveryFailureAlarm/Resource"
   }
  },
  "SpendMonitorDashboardF9F98187": {
   "Type": "AWS::CloudWatch::Dashboard",
   "Properties": {
    "DashboardBody": {
     "Fn::Join": [
      "",
      [
       "{\"widgets\":[{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":0,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Lambda Function Metrics\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/Lambda\",\"Invocations\",\"FunctionName\",\"",
       {
        "Ref": "SpendMonitorAgentBEC3B4B9"
       },
       "\",{\"stat\":\"Sum\"}],[\"AWS/Lambda\",\"Errors\",\"FunctionName\",\"",
       {
        "Ref": "SpendMonitorAgentBEC3B4B9"
       },
       "\",{\"stat\":\"Sum\"}],[\"AWS/Lambda\",\"Duration\",\"FunctionName\",\"",
       {
        "Ref": "SpendMonitorAgentBEC3B4B9"
       },
       "\",{\"yAxis\":\"right\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":6,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Spend Monitoring Metrics\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"SpendMonitor/Agent\",\"CurrentSpend\",{\"period\":3600}],[\"SpendMonitor/Agent\",\"ProjectedMonthlySpend\",{\"period\":3600}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":12,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Alert Delivery Metrics\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"SpendMonitor/Agent\",\"AlertDeliveryCount\",\"Status\",\"Success\",{\"stat\":\"Sum\"}],[\"SpendMonitor/Agent\",\"AlertDeliveryCount\",\"Status\",\"Failure\",{\"stat\":\"Sum\"}]],\"yAxis\":{}}}]}"
      ]
     ]
    },
    "DashboardName": "SpendMonitorAgent"
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/SpendMonitorDashboard/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/02OTW7CMBCFz8LemUJoDwCt6KZSUWCPJrYbTBxPlLGJkOW7V3baqqv3zXvzV0O9eYb1CmeupOora1qIJ4+yFzjzJVrqGOIHde8ThVG8frlfToIdQzzTaGT2CyShHg4HUi3EM7ZWlyRDEhaHViHEQ3DSG3I5+s9HPQ2G2ZBLwuAAsaFlvuiRrJGP0lcoCd5ekFl7hl0WwVvYB9lrv0fWQt+18wyxCT9LQv5BWgpqRi+vEHcWpyFHC7whX1vCSWXrr0hJNJopTFKLcubksTOuy02fwY/BJ+FIabjx072uYfMC69WNjamm4LwZNDSLfgPuuZzbaQEAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "SpendMonitorStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "SNSTopicArn": {
   "Description": "SNS Topic ARN for spend alerts",
   "Value": {
    "Ref": "SpendAlertTopic7E2315E1"
   }
  },
  "AgentFunctionName": {
   "Description": "Lambda function name for the spend monitor agent",
   "Value": {
    "Ref": "SpendMonitorAgentBEC3B4B9"
   }
  },
  "DeviceTokenTableName": {
   "Description": "DynamoDB table name for device token storage",
   "Value": {
    "Ref": "DeviceTokenTable5D54629B"
   }
  },
  "LogGroupName": {
   "Description": "CloudWatch Log Group for the spend monitor agent",
   "Value": {
    "Ref": "SpendMonitorLogGroup367930B7"
   }
  },
  "OperationalAlertTopicArn": {
   "Description": "SNS Topic ARN for operational alerts",
   "Value": {
    "Ref": "OperationalAlertTopicB3F33E16"
   }
  },
  "DashboardURL": {
   "Description": "CloudWatch Dashboard URL for monitoring",
   "Value": {
    "Fn::Join": [
     "",
     [
      "https://us-east-1.console.aws.amazon.com/cloudwatch/home?region=us-east-1#dashboards:name=",
      {
       "Ref": "SpendMonitorDashboardF9F98187"
      }
     ]
    ]
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}